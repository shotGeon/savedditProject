<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Psti-Mapper">

<sql id="Allsearch">
	<if test="!keyword.equals('') and keyword!=null">
		and (			
			inst_nm like '%'||#{keyword}||'%'     
		OR	inst_adres  like '%'||#{keyword}||'%'
		OR	inst_telno  like '%'||#{keyword}||'%'
		)
	</if>
</sql>


<select id="selectManageByManageNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.ManageVO">
SELECT
    manage_no
   ,sttus_code
   ,update_ymd
   ,inst_nm
   ,inst_no
FROM
    manage
WHERE
	manage_no = #{manageNo}	
	
</select>


<select id="selectPstiNextVal" resultType="java.lang.Integer">
SELECT 
		PSTI_SEQ.NEXTVAL AS PSTI_NO
	  FROM DUAL
</select>

<select id="selectPstiCityNo" parameterType="java.lang.String" resultType="java.lang.String">
	SELECT 
		CODE_NM2 
	FROM 
		CMMN_CODE 
	WHERE 
		CODE_NM1=#{city}
</select>

<select id="selectInspList" parameterType="com.spring.compass.command.SearchCriteria" resultType="com.spring.compass.vo.InspVO">
SELECT
    insp_no
   ,pbht_no
   ,inst_no
   ,inst_nm
   ,inst_adres
   ,inst_telno
   ,emp_cnt
   ,rmnd_kit_cnt
   ,area_no
FROM
    insp
    where insp_no is not null
    <include refid="Allsearch" />

</select>

<select id="selectSearchInspListCount" parameterType="com.spring.compass.command.SearchCriteria" resultType="java.lang.Integer">
		select
		count(*)
		from
		insp
		where insp_no is not null  			  	
		<include refid="Allsearch" />

</select>


<select id="selectTestResultCheck" parameterType="com.spring.compass.vo.TestResultCheckVO" resultType="com.spring.compass.vo.TestResultCheckVO">
SELECT
    A.RRN  
    ,A.PSTI_NM
    ,A.GENDER 
    ,B.HTSC_YMD 
    ,C.PSTV_YN 
    ,C.RES_YMD 
    ,D.INST_NM 
    ,E.SMPL_RES_CODE
FROM
   (select a.*
     from psti a,
    (
     select rrn, max(wrt_ymd) as wrt_ymd
       from psti
      group by rrn
    ) b
where a.rrn = b.rrn
      and a.wrt_ymd = b.wrt_ymd) A, HTSC B, SMPL E, SMPL_RESULT C, INSP D
    where A.PSTI_NO = B.PSTI_NO
      and A.MANAGE_NO = E.MANAGE_NO
      and E.SMPL_NO = C.SMPL_NO
      and A.INSP_NO = D.INSP_NO
      and A.PSTI_NM = #{pstiNm}
      and A.RRN = #{rrn}
</select>





<update id="registPsti" parameterType="com.spring.compass.vo.PstiVO">
INSERT INTO psti (
    psti_no
   ,insp_no
   ,psti_nm
   ,rrn
   ,gender
   ,pregn_yn
   ,nlty
   ,psti_telno
   ,psti_adres
   ,job_code
   ,fever_yn
   ,symptms
   ,vac_code
   ,wrt_ymd
   ,del_ymd
   ,rechkd_yn
   ,chkd_yn
   ,manage_no
   ,area_no
) VALUES (
    #{pstiNo}
   ,#{inspNo}           
   ,#{pstiNm}  
   ,#{rrn}    
   ,#{gender}    
   ,#{pregnYn}   
   ,#{nlty} 
   ,#{pstiTelno}   
   ,#{pstiAdres}
   ,#{jobCode}  
   ,#{feverYn}
   ,#{symptms}
   ,#{vacCode}
   ,sysdate   
   ,sysdate + (INTERVAL '1' DAY)
   ,#{rechkdYn}   
   ,#{chkdYn}  
   ,null
   ,#{areaNo}
)


</update>


<select id="selectPstiByPstiNo" parameterType="java.lang.String"
	resultType="com.spring.compass.vo.PstiVO">
SELECT
    psti_no
   ,insp_no
   ,psti_nm
   ,rrn
   ,gender
   ,pregn_yn
   ,nlty
   ,psti_telno
   ,psti_adres
   ,job_code
   ,fever_yn
   ,symptms
   ,vac_code
   ,wrt_ymd
   ,del_ymd
   ,rechkd_yn
   ,chkd_yn
   ,manage_no
FROM
    psti
WHERE
	psti_no = #{pstiNo}
</select>

<select id="selectVPstiByPstiNo" parameterType="java.lang.String"
		resultType="com.spring.compass.command.VPstiCommand">
SELECT
        psti_no	   ,insp_no	   ,psti_nm
	   ,rrn	   ,gender	   ,pregn_yn
	   ,nlty	   ,psti_telno	   ,psti_adres
	   ,job_code	   ,fever_yn	   ,symptms
	   ,vac_code	   ,wrt_ymd	   ,del_ymd
	   ,rechkd_yn	   ,chkd_yn	   ,manage_no
	   ,area_no
       ,fn_get_bir_by_psti_no(a.psti_no) as bir
       ,fn_get_age_by_psti_no(a.psti_no) as age
FROM
        psti
WHERE
    psti_no = #{pstiNo}
</select>

<select id="selectVPstiByManageNo" parameterType="java.lang.String"
		resultType="com.spring.compass.command.VPstiCommand">
SELECT
        psti_no	   ,insp_no	   ,psti_nm
	   ,rrn	   ,gender	   ,pregn_yn
	   ,nlty	   ,psti_telno	   ,psti_adres
	   ,job_code	   ,fever_yn	   ,symptms
	   ,vac_code	   ,wrt_ymd	   ,del_ymd
	   ,rechkd_yn	   ,chkd_yn	   ,manage_no
	   ,area_no
	   ,bir
	   ,age
FROM
        (
            SELECT
                    a.psti_no                   ,a.insp_no                   ,a.psti_nm
                   ,a.rrn                   ,a.gender                   ,a.pregn_yn
                   ,a.nlty                   ,a.psti_telno                   ,a.psti_adres
                   ,a.job_code                   ,a.fever_yn                   ,a.symptms
                   ,a.vac_code                   ,a.wrt_ymd                   ,a.del_ymd
                   ,a.rechkd_yn                   ,a.chkd_yn                   ,a.manage_no
                   ,a.area_no
                   ,fn_get_bir_by_psti_no(a.psti_no) as bir
                   ,fn_get_age_by_psti_no(a.psti_no) as age
              from psti a,
                    (
                        select manage_no, max(wrt_ymd) as wrt_ymd
                          from psti
                         group by manage_no
                    ) b
             where a.manage_no = b.manage_no
                   and a.wrt_ymd = b.wrt_ymd
            order by a.manage_no desc
        )
WHERE
    manage_no = #{manageNo}
</select>

<select id="selectVSmplResultByManageNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.SmplResultVO">
SELECT
    smpl_no   ,pbht_no   ,inst_no
   ,manage_no   ,chkd_yn   ,req_ymd
   ,pstv_yn   ,res_ymd
  FROM
        (
            SELECT 
                a.smpl_no               ,a.pbht_no               ,a.inst_no
               ,a.manage_no               ,a.chkd_yn               ,a.req_ymd
               ,a.pstv_yn               ,a.res_ymd
            FROM V_SMPL_RESULT A,
                    (
                        SELECT manage_no, max(req_ymd) as req_ymd
                          FROM V_SMPL_RESULT
                        GROUP BY manage_no
                    ) B
            WHERE
                A.MANAGE_NO = B.MANAGE_NO
                AND A.REQ_YMD = B.REQ_YMD
            ORDER BY a.req_ymd desc
        )
WHERE
    manage_no = #{manageNo}
</select>

<select id="selectVSmplResultBySmplNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.SmplResultVO">
SELECT
    smpl_no   ,pbht_no   ,inst_no
   ,manage_no   ,chkd_yn   ,req_ymd
   ,pstv_yn   ,res_ymd
  FROM V_SMPL_RESULT
WHERE
    smpl_no = #{smplNo}
</select>

<select id="selectVDgnssResultByDgnssNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.DgnssResultVO">
SELECT
    dgnss_no   ,hspt_no   ,type
   ,child_no   ,manage_no   ,req_ymd
   ,dgnss_code   ,cancle_ymd   ,dgnss_result_code
   ,res_ymd   ,dgnss_note
  FROM v_dgnss_result
WHERE
    dgnss_no = #{dgnssNo}
</select>

<select id="selectVDgnssResultByManageNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.DgnssResultVO">
SELECT
    dgnss_no   ,hspt_no   ,type
   ,child_no   ,manage_no   ,req_ymd
   ,dgnss_code   ,cancle_ymd   ,dgnss_result_code
   ,res_ymd   ,dgnss_note
  FROM
        (
            SELECT 
                a.dgnss_no               ,a.hspt_no               ,a.type
               ,a.child_no               ,a.manage_no               ,a.req_ymd
               ,a.dgnss_code               ,a.cancle_ymd               ,a.dgnss_result_code
               ,a.res_ymd               ,a.dgnss_note
            FROM v_dgnss_result A,
                    (
                        SELECT manage_no, max(req_ymd) as req_ymd
                          FROM v_dgnss_result
                        GROUP BY manage_no
                    ) B
            WHERE
                A.MANAGE_NO = B.MANAGE_NO
                AND A.REQ_YMD = B.REQ_YMD
            ORDER BY a.req_ymd desc
        )
WHERE
    manage_no = #{manageNo}
</select>


<select id="selectPstiByManageNo" parameterType="java.lang.String"
	resultType="com.spring.compass.vo.PstiVO">
SELECT
    psti_no
   ,insp_no
   ,psti_nm
   ,rrn
   ,gender
   ,pregn_yn
   ,nlty
   ,psti_telno
   ,psti_adres
   ,job_code
   ,fever_yn
   ,symptms
   ,vac_code
   ,wrt_ymd
   ,del_ymd
   ,rechkd_yn
   ,chkd_yn
   ,manage_no
FROM
    psti
WHERE
	manage_no = #{manageNo}
</select>
<select id="selectPstiListByInspNo" parameterType="java.lang.String"
	resultType="com.spring.compass.vo.PstiVO">
SELECT
    psti_no
   ,insp_no
   ,psti_nm
   ,rrn
   ,gender
   ,pregn_yn
   ,nlty
   ,psti_telno
   ,psti_adres
   ,job_code
   ,fever_yn
   ,symptms
   ,vac_code
   ,wrt_ymd
   ,del_ymd
   ,rechkd_yn
   ,chkd_yn
   ,manage_no
FROM
    psti
WHERE
	insp_no = #{inspNo}
ORDER BY
	wrt_ymd desc
</select>


<select id="selectSckbdreqBySckbdreqNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.SckbdreqVO">
SELECT
    sckbdreq_no
   ,type
   ,child_no
   ,hspt_no
   ,manage_no
   ,sckbdreq_ymd
   ,cancle_ymd
   ,sckbdreq_code
FROM
    sckbdreq
WHERE
	sckbdreq_no = #{sckbdreqNo}
</select>

<select id="selectSckbdreqByManageNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.SckbdreqVO">

SELECT
    sckbdreq_no   ,type   ,child_no
   ,hspt_no   ,manage_no   ,sckbdreq_ymd
   ,cancle_ymd   ,sckbdreq_code
FROM
        (    
            SELECT
                a.sckbdreq_no               ,a.type               ,a.child_no
               ,a.hspt_no               ,a.manage_no               ,a.sckbdreq_ymd
               ,a.cancle_ymd               ,a.sckbdreq_code
            FROM
                sckbdreq a,
                    (
                        select manage_no, max(sckbdreq_ymd) as sckbdreq_ymd
                          from sckbdreq
                         group by manage_no
                    ) b
            where
                a.manage_no = b.manage_no
                and a.sckbdreq_ymd = b.sckbdreq_ymd
            order by a.sckbdreq_ymd desc
        )
WHERE
	manage_no = #{manageNo}
</select>

<select id="selectInptntByManageNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.InptntVO">
SELECT
    inptnt_no   ,hspt_no   ,manage_no
   ,in_ymd   ,out_ymd   ,hsptlz_code
FROM
    (
         SELECT
            a.inptnt_no           ,a.hspt_no           ,a.manage_no
           ,a.in_ymd           ,a.out_ymd           ,a.hsptlz_code
        FROM
            inptnt a,
            (
                    select manage_no, max(in_ymd) as in_ymd
                      from inptnt
                     group by manage_no
            ) b
         where a.manage_no = b.manage_no
               and a.in_ymd = b.in_ymd
         order by in_ymd desc
    )
where manage_no = #{manageNo}
</select>

<select id="selectInptntByInptntNo" parameterType="java.lang.String"
		resultType="com.spring.compass.vo.InptntVO">
SELECT
    inptnt_no   ,hspt_no   ,manage_no
   ,in_ymd   ,out_ymd   ,hsptlz_code
FROM
	inptnt
where
	inptnt_no = #{inptntNo}
</select>

<select id="selectInptntNextVal" resultType="java.lang.Integer">
	SELECT INPTNT_SEQ.NEXTVAL AS INPTNT_NO FROM DUAL
</select>
<select id="selectDgnssNextVal" resultType="java.lang.Integer">
	SELECT DGNSS_SEQ.NEXTVAL AS DGNSS_NO FROM DUAL
</select>
<select id="selectSckbdreqNextVal" resultType="java.lang.Integer">
	SELECT SCKBDREQ_SEQ.NEXTVAL AS SCKBDREQ_NO FROM DUAL
</select>
<select id="selectSlfptntNextVal" resultType="java.lang.Integer">
	SELECT SLFPTNT_SEQ.NEXTVAL AS SLFPTNT_NO FROM DUAL
</select>
<select id="selectSmplNextVal" resultType="java.lang.Integer">
	SELECT SMPL_SEQ.NEXTVAL AS SMPL_NO FROM DUAL
</select>
<select id="selectManageNextVal" resultType="java.lang.Integer">
	SELECT MANAGE_SEQ.NEXTVAL AS MANAGE_NO FROM DUAL
</select>
<select id="selectHtscNextVal" resultType="java.lang.Integer">
	SELECT HTSC_SEQ.NEXTVAL AS HTSC_NO FROM DUAL
</select>
<select id="selectCnfmNextVal" resultType="java.lang.Integer">
	SELECT CNFM_SEQ.NEXTVAL AS CNFM_NO FROM DUAL
</select>

</mapper>

